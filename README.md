# FreeRTOS Ported to Raspberry Pi 2B

Fork from James Walmsley's RPi 1 FreeRTOS build, modified for framebuffer support and the RPi2B.
https://github.com/jameswalmsley/RaspberryPi-FreeRTOS

The USB/Ethernet portion is a port of USPi, a LAN9514 USB driver.
https://github.com/rsta2/uspi

TCP/IP portion is the official FreeRTOS driver with modifications for compatability.
http://www.freertos.org/FreeRTOS-Labs/RTOS_labs_download.html

Due to time constraits, this build is full of debug statements, inconsistent code formatting, and less than optimised code. As of now, only ARP has been tested to work. For reasons not yet known, interrupts become disabled before calls to DWHCIDeviceTransferStage which hangs the system. I suspect portYIELD_WITHIN_API within the implimentation of queues switches contexts while interrupts are disabled.

## Howto Build

Type make

You need to modify the arm-non-eabi- toolchain locations in the Makefile:

    kernel.elf: LDFLAGS += -L"/usr/lib/gcc/arm-none-eabi/4.9.3" -lgcc
    kernel.elf: LDFLAGS += -L"/usr/lib/arm-none-eabi/lib" -lc

On Ubuntu you can install the toolchain with: sudo apt-get install gcc-arm-none-eabi

Format your SD card as FAT32

Copy the bootcode.bin and start.elf from here https://github.com/raspberrypi/firmware/tree/master/boot

Copy the config.txt from /boot_stuff onto the SD card to fix over/underscanning

Copy the kernel7.img generated by make

You should see the green ACT LED continuously blink as proof the task schedualer is working.

##Configuration
GCC -finstrument-functions enables tracing at the beginning and end of every function. You can add __attribute__((no_instrument_function)) to functions to disable tracing in critical sections.

The framebuffer is explicitly for debug information, this build does not take full advantage of the RPi GPU. Printing to the screen takes several milliseconds so it is adviseable to disable it. In the demo main.c, set loaded = 0.
